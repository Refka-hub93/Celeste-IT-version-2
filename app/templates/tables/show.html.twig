{% extends 'base.html.twig' %}


{% block javascripts %}
	<script src="{{ asset('js/table.js') }}" defer></script>
	<script src="{{ asset('js/columnsApi.js') }}" defer></script>
	<script src="{{ asset('js/tableApi.js') }}" defer></script>
	<script src="{{ asset('js/cardsApi.js') }}" defer></script>
	<script src="{{ asset('js/notification.js') }}" defer></script>
	<script src="{{ asset('js/drag.js') }}" defer></script>

{% endblock %}

{% block title %}
	{{ tableau.title }}
{% endblock %}


{% block body %}

	{# Zone Notification #}
	<div id="notification-wrapper" class="position-fixed  end-0 mb-4 me-4" style="z-index: 9999;">

		<button id="notif-bell" class="btn  position-relative">
			🔔
			<span id="notif-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
		</button>

		<div id="notif-list" class="card shadow mt-2 p-2 d-none" style="width: 300px; max-height: 400px; overflow-y: auto;">
			<div class="card-body p-2">
				<h5 class="card-title bg-primary p-2 text-white">Notifications</h5>

				<ul id="notif-items" class="list-unstyled text-start mb-0"></ul>
			</div>
		</div>
	</div>

	<div class="container mt-5">
		<h1 class="display-4 text-center fw-bold text-primary">
			<i class="bi bi-kanban-fill me-2" style="color: #2667ff;"></i>

			{{ tableau.title }}
		</h1>

		{# Lien retour #}

		<div class="text-center mt-4">
			<a href="{{ path('app_tables') }}" class="btn btn-secondary">
				⬅️ Retour à mes tableaux
			</a>
		</div>
	</div>

	{# Zone principale du tableau (Board) avec identifiant dynamique #}

	<main class="board d-flex flex-wrap   gap-3 p-1" id="board" data-table-id="{{ tableau.id }}">
		<div class="text-center mb-4">
			<button id="add-list-button" class="btn btn-primary">Ajouter une liste</button>
			<div class="cards"></div>
		</div>
		<div
			class="lists-container" id="lists-container">


			{# BOUCLE SUR LES COLONNES #}
			{% for column in tableau.columns %}
				<div class="list border p-2 rounded shadow" data-column-id="{{ column.id }}">
					<div
						class="list-header m-1">
						{# titre de la colonne #}
						<input type="text" class="list-title form-control" value="{{ column.columnTitle }}" placeholder="Titre de la liste…">

						<button class="add-card-button btn pe-2 m-3">Ajouter une carte</button>
						<button class="remove-list-button btn btn-danger">Supprimer cette liste</button>
					</div>

					<ul
						class="cards text-center me-4 pe-2">
						{# 🔁 BOUCLE SUR LES CARTES DE LA COLONNE #}


						{% for card in column.cards %}
							<li class="card" draggable="true" role="listitem" data-card-id="{{ card.id }}">

								<div class="card-body">
									<h5 class="card-title btn" data-bs-toggle="modal" data-bs-target="#cardModal" data-bs-title="{{ card.cardTitle }}" data-bs-description="{{ card.description }}" data-bs-comments="">
										{{ card.cardTitle }}
									</h5>

									<button class="remove-card-button">🗑 Supprimer</button>
								</div>
							</li>
						{% endfor %}
					</ul>
				</div>
			{% endfor %}


		</div>
	</main>

	{# Gabarit HTML invisible pour générer dynamiquement une liste (colonne) via JavaScript #}
	<template id="list-template">
		<section class="list border p-2 rounded shadow  " data-column-id="">
			<div class="list-header m-1">
				<input type="text" class="list-title form-control" placeholder="Titre de la liste">
				<button class="add-card-button btn pe-2 m-3">
					Ajouter une carte
				</button>

				<button class="remove-list-button btn btn-danger">Supprimer cette liste</button>
				{# Bouton pour supprimer cette liste (colonne) #}
			</div>
			<ul class="cards text-center me-4 pe-2"></ul>
		</section>
	</template>


	<template id="card-template">
		<li class="card" draggable="true" data-card-id="">
			<div class="card-body">
				<h5 class="card-title btn">Titre</h5>
				<button class="remove-card-button">🗑 Supprimer</button>
			</div>
		</li>
	</template>


	{# Modal Bootstrap #}
	<div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content p-3">

				<div class="modal-header">
					<h5 class="modal-title fw-bold" id="cardModalLabel">Créer une carte</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>

				<div class="modal-body">
					<form id="card-details-form">

						<div class="mb-4 w-100">
							<label for="card-title" class="form-label fw-semibold">Titre de la carte</label>
							<input type="text" id="card-title" class="form-control form-control-lg w-100" placeholder="Titre de la carte">
						</div>

						<div class="mb-4 w-100">
							<label for="card-description" class="form-label fw-semibold">Description</label>
							<textarea id="card-description" class="form-control form-control-lg w-100" rows="4" placeholder="Ajoutez une description"></textarea>
						</div>

						<div class="mb-4 w-100">
							<label for="card-comments" class="form-label fw-semibold">Commentaires</label>
							<textarea id="card-comments" class="form-control form-control-lg w-100" rows="4" placeholder="Ajoutez des commentaires"></textarea>
						</div>

						
						<div class="mb-4 w-100">
							<label for="card-attachment" class="form-label fw-semibold">Pièce jointe (URL)</label>
							<input type="text" id="card-attachment" class="form-control" placeholder="Ex. https://...">
						</div>

						<div class="mb-4 w-100">
							<label for="card-deadline" class="form-label fw-semibold">Date limite</label>
							<input type="datetime-local" id="card-deadline" class="form-control">
						</div>


						<div class="d-grid">
							<button type="submit" class="btn btn-primary">Enregistrer</button>
						</div>

					</form>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
				</div>

			</div>
		</div>
	</div>

	{% if tableau.users.contains(app.user) %}
		<div class="container mt-5">
			<div class="card shadow p-4">
				<h5 class="card-title">Ajouter un membre au tableau</h5>
				<form id="add-member-form" class="row g-3">
					<div class="col-md-8">
						<input type="email" id="email-to-add" class="form-control" placeholder="Email de l'utilisateur" required>
					</div>
					<div class="col-md-4">
						<button type="submit" class="btn btn-success w-100">Ajouter</button>
					</div>
				</form>
				<div id="add-member-feedback" class="mt-3"></div>
			</div>
		</div>
	{% endif %}

{% endblock %}
